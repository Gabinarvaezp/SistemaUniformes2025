<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIFORMES DON BOSCO - Sistema de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES Y TEM√ÅTICOS --- */
        :root {
            --color-primary: #FFCC00; /* Amarillo Don Bosco */
            --color-secondary: #000000;
            --color-background: #f8f8f8;
            --color-white: #ffffff;
            --color-danger: #e74c3c;
            --color-success: #2ecc71;
            --color-info: #3498db;
        }

        body {
            font-family: 'Poppins', 'Arial', sans-serif;
            background-color: var(--color-background);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1100px; /* Aumentamos el ancho para la tabla de registro */
            background: var(--color-white);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 50px;
        }

        h1, h2, h3 {
            color: var(--color-secondary);
            text-align: center;
            font-weight: 700;
        }

        .logo-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .logo-title img {
            width: 50px;
            height: 50px;
        }

        hr {
            border: 0;
            height: 3px;
            background-color: var(--color-primary);
            margin: 25px 0;
            border-radius: 5px;
        }

        /* --- BOTONES PRINCIPALES / ACCIONES --- */
        .btn {
            display: block;
            width: 100%;
            padding: 18px 20px;
            margin: 15px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--color-secondary);
            color: var(--color-primary);
        }

        .btn-primary:hover {
            background-color: #333333;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            padding: 10px 15px;
            font-size: 1em;
            width: auto;
        }
        
        .btn-secondary:hover {
            background-color: #f7e089;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--color-success);
            color: var(--color-white);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--color-danger);
            color: var(--color-white);
            width: auto;
            padding: 12px 25px;
            margin: 20px auto;
            box-shadow: none;
        }

        .btn-delete {
            background-color: var(--color-danger);
            color: var(--color-white);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        /* --- FORMULARIOS --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea,
        .ts-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--color-white);
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .ts-control.focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row > .form-group {
            flex: 1;
        }
        
        /* --- TABLAS (Registro de Venta) --- */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        
        .products-table th {
            background-color: var(--color-secondary);
            color: var(--color-primary);
            padding: 12px 5px;
            font-size: 0.95em;
            white-space: nowrap;
            text-transform: uppercase;
        }

        .products-table td {
            padding: 8px 5px;
            border: 1px solid #eee;
            vertical-align: middle;
            background-color: #fff;
        }

        .products-table input[type="number"],
        .products-table input[type="text"],
        .products-table select,
        .products-table .ts-wrapper {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            font-size: 0.9em;
            min-height: 35px;
        }
        
        .products-table .ts-wrapper {
            text-align: left;
            padding: 0;
            border: 1px solid #ccc;
        }

        .products-table .ts-control {
             padding: 5px; 
             min-height: 35px;
             border: none;
             box-shadow: none;
        }

        .products-table input[type="text"]:disabled,
        .products-table input[type="number"]:disabled {
            background-color: #f7f7f7;
            font-weight: bold;
        }
        
        .products-table .btn-delete {
            padding: 5px 8px;
        }

        /* --- RESUMEN DE PAGOS --- */
        .summary-box {
            background-color: #f4f4f4;
            border: 2px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .summary-total {
            font-weight: 700;
            font-size: 1.5em;
            color: var(--color-danger);
            border-top: 1px dashed #ccc;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* --- HISTORIAL DE VENTAS --- */
        #ventas-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        #ventas-table th, #ventas-table td {
            padding: 10px 5px;
            border: 1px solid #eee;
        }

        #ventas-table thead th {
             background-color: var(--color-secondary);
             color: var(--color-primary);
             font-size: 0.85em;
        }
        
        .status-entregado {
            color: var(--color-success);
            font-weight: bold;
        }
        
        .status-pendiente {
            color: var(--color-danger);
            font-weight: bold;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="inicio-section">
            <h1 class="logo-title">UNIFORMES DON BOSCO ‚öúÔ∏è</h1>
            <p style="text-align: center; color: #555; font-size: 1.1em;">Sistema amigable de Cotizaci√≥n y Ventas R√°pido.</p>
            <hr>
            <button class="btn btn-primary" onclick="showSection('registro-ventas')">üìù REGISTRAR VENTA</button>
            <button class="btn btn-primary" onclick="showSection('cotizador')">üí∞ COTIZAR R√ÅPIDO</button>
            <button class="btn btn-primary" onclick="showSection('historial')">üìä VER HISTORIAL</button>
        </div>

        <div id="cotizador-section" style="display: none;">
            <h2 class="logo-title">üí∞ Cotizador R√°pido</h2>
            <hr>
            <button class="btn btn-secondary" onclick="showSection('inicio')">‚Üê Volver al Inicio</button>

            <h3 style="text-align: left; margin-top: 30px;">Datos del Cliente (Opcional)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Cliente:</label>
                    <input type="text" id="cot-cliente-nombre" placeholder="Nombre">
                </div>
                <div class="form-group">
                    <label>Tel√©fono:</label>
                    <input type="text" id="cot-cliente-telefono" placeholder="WhatsApp">
                </div>
            </div>

            <h3 style="text-align: left; margin-top: 30px;">1. Agregar Uniforme Completo (por Talla Base)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Nivel:</label>
                    <select id="cot-nivel-select" onchange="loadCotizadorTallas()">
                        <option value="primaria-nino">Primaria (Ni√±o)</option>
                        <option value="primaria-nina">Primaria (Ni√±a)</option>
                        <option value="bachillerato-nino">Bachillerato (Ni√±o)</option>
                        <option value="bachillerato-nina">Bachillerato (Ni√±a)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Talla Base:</label>
                    <select id="cot-talla-select">
                        <option value="">Seleccione Talla</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success" onclick="addUniformeCompleto()">‚ûï A√±adir Uniforme Completo</button>
            
            <h3 style="text-align: left; margin-top: 30px;">2. Agregar Prenda Individual</h3>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Art√≠culo/Talla/Precio:</label>
                    <select id="cot-prenda-select"></select>
                </div>
                <div class="form-group" style="flex: 0.5;">
                    <label>Cantidad:</label>
                    <input type="number" id="cot-qty-indiv" value="1" min="1">
                </div>
            </div>
            <button class="btn btn-success" onclick="addPrendaIndividual()">‚ûï A√±adir Prenda Individual</button>

            <h3 style="text-align: center; margin-top: 30px;">üõí Resumen de Cotizaci√≥n</h3>
            <div id="cotizacion-items-list">
                <p style="text-align: center; color: #777;">A√∫n no se han agregado prendas.</p>
            </div>
            
            <div class="cotizacion-total-footer" style="text-align: right;">
                TOTAL: <span id="total-cotizacion">$ 0</span>
            </div>

            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-danger" style="flex: 1;" onclick="resetCotizacion()">üóëÔ∏è Limpiar Cotizaci√≥n</button>
                <button class="btn btn-success" style="flex: 1; background-color: #25D366;" id="btn-whatsapp" disabled onclick="enviarWhatsapp()">üí¨ Enviar por WhatsApp</button>
            </div>
        </div>

        <div id="registro-ventas-section" style="display: none;">
            <h2 class="logo-title">üìù Registrar Venta</h2>
            <hr>
            <button class="btn btn-secondary" onclick="showSection('inicio')">‚Üê Volver al Inicio</button>

            <h3 style="text-align: left; margin-top: 20px;">Informaci√≥n de la Venta</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="text" id="reg-fecha" disabled>
                </div>
                <div class="form-group">
                    <label>No. Recibo (Talonario):</label>
                    <input type="number" id="reg-talonario" placeholder="Ej: 1005" required>
                </div>
                <div class="form-group">
                    <label>Nivel / Tipo de Venta:</label>
                    <select id="reg-nivel-ciclo" onchange="resetReciboSelects()">
                        <option value="todos">Todos (General)</option>
                        <option value="primaria">Primaria</option>
                        <option value="bachillerato">Bachillerato</option>
                        <option value="manual">Manual (Precio Libre)</option>
                    </select>
                </div>
            </div>

            <h3 style="text-align: left; margin-top: 20px;">Informaci√≥n del Cliente</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Cliente / Estudiante:</label>
                    <input type="text" id="reg-nombre" placeholder="Nombre Completo (Requerido)" required>
                </div>
                <div class="form-group">
                    <label>Celular:</label>
                    <input type="text" id="reg-celular" placeholder="31X XXX XXXX">
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago:</label>
                    <select id="reg-metodo-pago">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Nequi">Nequi</option>
                        <option value="Daviplata">Daviplata</option>
                        <option value="Transferencia">Transferencia Bancaria</option>
                        <option value="Tarjeta">Tarjeta (Datafono)</option>
                    </select>
                </div>
            </div>

            <h3 style="text-align: left; margin-top: 20px;">üõí Detalle de Productos</h3>
            <div class="table-container">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">CANT</th>
                            <th style="width: 45%;">ART√çCULO</th>
                            <th style="width: 10%;">TALLA</th>
                            <th style="width: 15%;">VR. UNIT</th>
                            <th style="width: 15%;">VR. TOTAL</th>
                            <th style="width: 5%;">ENTR.</th>
                            <th style="width: 5%;">DEL.</th>
                        </tr>
                    </thead>
                    <tbody id="recibo-productos-tbody">
                    </tbody>
                </table>
            </div>
            <button class="btn btn-secondary" style="width: auto; padding: 8px 15px; margin: 15px 0 20px 0; display: inline-block;" onclick="addRow()">+ Agregar Fila</button>

            <h3 style="text-align: left; margin-top: 20px;">Detalles de Medidas / Arreglos (Opcional)</h3>
            <div class="form-row">
                <div class="form-group"><label>Cadera (C):</label><input type="text" id="medida-cadera" placeholder="Ej: C 82"></div>
                <div class="form-group"><label>Busto/Pecho (B):</label><input type="text" id="medida-busto" placeholder="Ej: B 98"></div>
                <div class="form-group"><label>Cintura (T):</label><input type="text" id="medida-cintura" placeholder="Ej: T 42"></div>
                <div class="form-group"><label>Largo (L):</label><input type="text" id="medida-largo" placeholder="Ej: L 97"></div>
                <div class="form-group"><label>Ancho (A):</label><input type="text" id="medida-ancho" placeholder="Ej: A 82"></div>
            </div>
            <div class="form-group">
                <label>Otros Detalles:</label>
                <textarea id="medida-otros" placeholder="Pantal√≥n ajustado de ruedo, etc." rows="2"></textarea>
            </div>


            <div class="summary-box">
                <div class="summary-item">
                    <span>Subtotal de Productos:</span>
                    <span id="reg-subtotal-display">$ 0</span>
                </div>
                <div class="summary-item">
                    <label for="reg-descuento">Descuento ($):</label>
                    <input type="text" id="reg-descuento" value="0" style="width: 100px; text-align: right; border: 1px solid var(--color-danger);" onkeyup="this.value=formatPriceInput(this.value); calculateReciboTotal();">
                </div>
                <div class="summary-item summary-total" style="color: var(--color-secondary);">
                    <span>TOTAL A PAGAR:</span>
                    <span id="reg-total-display">$ 0</span>
                </div>
                <hr style="background-color: #ddd;">
                <div class="form-group">
                    <label for="reg-abono" style="font-weight: 700; font-size: 1.1em;">Abono ($):</label>
                    <input type="text" id="reg-abono" value="0" placeholder="0" onkeyup="this.value=formatPriceInput(this.value); calculateReciboTotal();">
                </div>
                <div class="summary-item summary-total">
                    <span>SALDO PENDIENTE:</span>
                    <span id="reg-saldo-display">$ 0</span>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 30px; padding: 20px;" onclick="registrarVenta()">üíæ REGISTRAR VENTA Y VER HISTORIAL</button>
        </div>

        <div id="historial-section" style="display: none;">
            <h2 class="historial-title">üìä Historial de Ventas</h2>
            <hr>
            <button class="btn btn-secondary" onclick="showSection('inicio')">‚Üê Volver al Inicio</button>
            
            <div style="display: flex; gap: 10px; margin: 20px 0; justify-content: center;">
                <button class="btn btn-primary" onclick="descargarExcel()" style="width: 50%;">‚¨áÔ∏è Descargar a Excel</button>
                <button class="btn btn-secondary" onclick="imprimirHistorial()" style="width: 50%;">üñ®Ô∏è Imprimir Historial</button>
            </div>

            <div class="table-container">
                <table id="ventas-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">Recibo No</th>
                            <th style="width: 8%;">Fecha</th>
                            <th style="width: 15%;">Cliente</th>
                            <th style="width: 8%;">Total</th>
                            <th style="width: 8%;">Abono</th>
                            <th style="width: 8%;">Saldo</th>
                            <th style="width: 8%;">Estado</th>
                            <th style="width: 25%;">Detalle de Productos</th>
                            <th style="width: 15%;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <button class="btn btn-danger" onclick="resetDatabase()">‚ùå ELIMINAR TODO EL HISTORIAL</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    
    <script>
        // --- 1. Base de Datos de Precios (UNIFICADA Y DETALLADA) ---
        const WHATSAPP_NEGOCIO = '573174703740';

        // Funci√≥n para limpiar el formato de precios (elimina puntos y comas de formato COP)
        const cleanPrice = (price) => {
            if (typeof price === 'string') {
                return parseFloat(price.replace(/[$. ]/g, '').replace(',', '.')) || 0;
            }
            return parseFloat(price) || 0;
        }

        // Funci√≥n para formatear el input de precios (solo n√∫meros, sin separadores de miles)
        const formatPriceInput = (value) => {
            return String(value).replace(/[^0-9]/g, '');
        }

        // Funci√≥n para convertir a formato COP (Moneda Colombiana)
        function formatCOP(number) {
            if (typeof number !== 'number' || isNaN(number)) return '$ 0';
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(number);
        }

        // Lista completa de todos los productos y sus precios. Data basada en las im√°genes.
        const PRODUCTOS_DATA = [
            // PRIMARIA (Basado en image_406206.png)
            { name: "BUSO SUDADERA", id: "BUSO_SUD", prices: { 4: 75000, 6: 75000, 8: 75000, 10: 80000, 12: 80000, 14: 85000, 16: 85000, S: 90000 }, nivel: 'primaria' },
            { name: "PANTAL√ìN SUDADERA", id: "PANTALON_SUD", prices: { 4: 50000, 6: 50000, 8: 50000, 10: 65000, 12: 65000, 14: 70000, 16: 70000, S: 75000 }, nivel: 'primaria' },
            { name: "CAMISETA DEPORTIVA P", id: "CAMISETA_DEP_P", prices: { 4: 30000, 6: 30000, 8: 30000, 10: 35000, 12: 35000, 14: 40000, 16: 40000, S: 42000 }, nivel: 'primaria' },
            { name: "PANTALONETA P", id: "PANTALONETA_P", prices: { 4: 25000, 6: 25000, 8: 25000, 10: 28000, 12: 28000, 14: 30000, 16: 30000, S: 35000 }, nivel: 'primaria' },
            { name: "PANTAL√ìN NI√ëO", id: "PANTALON_NINO", prices: { 4: 50000, 6: 50000, 8: 50000, 10: 55000, 12: 55000, 14: 60000, 16: 60000, S: 64000 }, nivel: 'primaria' },
            { name: "CAMIBUSO NI√ëO", id: "CAMIBUSO_NINO", prices: { 4: 40000, 6: 40000, 8: 40000, 10: 45000, 12: 45000, 14: 50000, 16: 50000, S: 54000 }, nivel: 'primaria' },
            { name: "CHAQUETA DIARIO P", id: "CHAQUETA_DIARIO_P", prices: { 4: 80000, 6: 80000, 8: 80000, 10: 85000, 12: 85000, 14: 90000, 16: 90000, S: 95000 }, nivel: 'primaria' },
            { name: "BATA NI√ëA GRADO 0-2", id: "BATA_NINA", prices: { 4: 65000, 6: 65000, 8: 70000, 10: 75000, 12: 75000, 14: 80000, 16: 88000 }, nivel: 'primaria' },
            { name: "JARDINERA GRADO 3-6", id: "JARDINERA_P", prices: { 10: 80000, 12: 80000, 14: 85000, 16: 85000, S: 85000 }, nivel: 'primaria' },
            { name: "CAMISA JARDINERA", id: "CAMISA_JARD", prices: { 10: 37000, 12: 39000, 14: 41000, 16: 43000, S: 45000 }, nivel: 'primaria' },
            
            // BACHILLERATO (Basado en image_4061e5.png)
            { name: "SUDADERA (Chaqueta + Pantal√≥n)", id: "CHAQUETA_SUD_B", prices: { 10: 130000, 12: 135000, 14: 145000, 16: 150000, S: 160000, M: 170000, L: 175000, XL: 180000, XXL: 190000 }, nivel: 'bachillerato' },
            { name: "CHAQUETA SUDADERA (Solo)", id: "CHAQ_SUD_B_SOLO", prices: { 10: 85000, 12: 85000, 14: 90000, 16: 95000, S: 95000, M: 100000, L: 105000, XL: 110000, XXL: 110000 }, nivel: 'bachillerato' },
            { name: "PANTAL√ìN SUDADERA BACH", id: "PANTALON_SUD_B", prices: { 10: 55000, 12: 55000, 14: 65000, 16: 70000, S: 75000, M: 75000, L: 80000, XL: 80000, XXL: 80000 }, nivel: 'bachillerato' },
            { name: "CHAQUETA DIARIO BACH", id: "CHAQUETA_DIARIO_B", prices: { 10: 85000, 12: 85000, 14: 90000, 16: 95000, S: 95000, M: 105000, L: 105000, XL: 105000, XXL: 105000 }, nivel: 'bachillerato' },
            { name: "SACO AZUL", id: "SACO_AZUL", prices: { 10: 65000, 12: 65000, 14: 66000, 16: 70000, S: 72000, M: 75000, L: 78000, XL: 80000, XXL: 80000 }, nivel: 'bachillerato' },
            { name: "CAMISETA TIPO POLO", id: "CAMISETA_POLO", prices: { 10: 28000, 12: 30000, 14: 35000, 16: 38000, S: 38000, M: 40000, L: 40000, XL: 45000, XXL: 45000 }, nivel: 'bachillerato' },
            { name: "CAMISETA DEPORTIVA BACH", id: "CAMISETA_DEP_B", prices: { 10: 30000, 12: 30000, 14: 30000, 16: 30000, S: 30000, M: 35000, L: 35000, XL: 35000, XXL: 35000 }, nivel: 'bachillerato' },
            { name: "PANTALONETA BACH", id: "PANTALONETA_B", prices: { 10: 28000, 12: 28000, 14: 30000, 16: 30000, S: 30000, M: 32000, L: 32000, XL: 35000, XXL: 35000 }, nivel: 'bachillerato' },
            // PANTAL√ìN NEGRO LINO (Tallas de ropa + Tallas de pantal√≥n)
            { 
                name: "PANTAL√ìN NEGRO LINO", 
                id: "PANTALON_LINO", 
                prices: { 
                    10: 40000, 12: 45000, 14: 50000, 16: 55000, S: 55000, M: 55000, L: 58000, XL: 60000, // Tallas de ropa
                    28: 43000, 30: 55000, 32: 55000, 34: 55000, 36: 60000, 38: 60000 // Tallas de pantal√≥n
                }, 
                nivel: 'bachillerato' 
            }, 
            { name: "JARDINERA BACH", id: "JARDINERA_B", prices: { 10: 80000, 12: 80000, 14: 85000, 16: 85000, S: 85000, M: 90000, L: 95000, XL: 95000, XXL: 95000 }, nivel: 'bachillerato' },
            { name: "SACO NI√ëA", id: "SACO_NINA", prices: { 10: 72000, 12: 74000, 14: 75000, 16: 75000, S: 78000, M: 78000, L: 80000, XL: 80000, XXL: 80000 }, nivel: 'bachillerato' },
            { name: "BUSO BLANCO ML", id: "BUSO_BLANCO", prices: { 10: 45000, 12: 50000, 14: 50000, 16: 55000, S: 55000, M: 60000, L: 60000, XL: 60000, XXL: 60000 }, nivel: 'bachillerato' },

            // OPCIONALES/OTROS (General)
            { 
                name: "BATA AZUL/BLANCA", 
                id: "BATA_AZUL_BLANCA", 
                prices: { 4: 50000, 6: 50000, 8: 55000, 10: 55000, 12: 60000, 14: 60000, 16: 65000, S: 68000 }, 
                nivel: 'todos'
            }, 
            { name: "OVEROL", id: "OVEROL", prices: { 4: 70000, 6: 70000, 8: 75000, 10: 80000, 12: 80000, 14: 85000, 16: 85000, S: 90000 }, nivel: 'todos' },
        ];

        // Mapa para b√∫squeda r√°pida (id -> producto)
        const PRODUCTOS_MAP = PRODUCTOS_DATA.reduce((map, prod) => {
            map[prod.id] = prod;
            return map;
        }, {});

        // Genera una lista plana de todos los art√≠culos con su talla y precio.
        const ALL_SKUS_LIST = [];
        PRODUCTOS_DATA.forEach(prod => {
            Object.keys(prod.prices).forEach(talla => {
                const price = prod.prices[talla];
                ALL_SKUS_LIST.push({
                    id: prod.id,
                    name: prod.name,
                    talla: talla,
                    price: price,
                    nivel: prod.nivel,
                    skuKey: `${prod.id}|${talla}|${price}` // Clave √∫nica para el value del select
                });
            });
        });

        // Definiciones de Uniformes Completos
        const UNIFORMES_COMPLETOS = {
            'primaria-nino': ["BUSO_SUD", "PANTALON_SUD", "CAMISETA_DEP_P", "PANTALONETA_P", "PANTALON_NINO", "CAMIBUSO_NINO", "CHAQUETA_DIARIO_P"],
            'primaria-nina': ["BUSO_SUD", "PANTALON_SUD", "CAMISETA_DEP_P", "PANTALONETA_P", "CHAQUETA_DIARIO_P", "JARDINERA_P", "CAMISA_JARD", "BATA_NINA"], 
            'bachillerato-nino': ["CHAQUETA_SUD_B", "PANTALON_SUD_B", "CHAQUETA_DIARIO_B", "SACO_AZUL", "CAMISETA_POLO", "CAMISETA_DEP_B", "PANTALONETA_B", "PANTALON_LINO"],
            'bachillerato-nina': ["CHAQUETA_SUD_B", "PANTALON_SUD_B", "CHAQUETA_DIARIO_B", "JARDINERA_B", "SACO_NINA", "BUSO_BLANCO", "CAMISETA_POLO", "CAMISETA_DEP_B"],
        };

        // --- 2. Variables Globales y Estado ---
        let currentSection = 'inicio';
        let selectedItems = {}; 
        let cotizacionItems = []; // Para el cotizador
        let ventas = JSON.parse(localStorage.getItem('ventasDB')) || [];
        let currentRowId = 0; 
        let tomSelectInstances = {}; // Para guardar instancias de Tom Select

        // --- 3. Funciones Generales ---

        function showSection(sectionId) {
            // Destruir instancias de Tom Select para evitar duplicados al cambiar de secci√≥n
            Object.values(tomSelectInstances).forEach(ts => {
                if (ts && typeof ts.destroy === 'function') ts.destroy();
            });
            tomSelectInstances = {};

            const allSections = ['inicio', 'cotizador', 'registro-ventas', 'historial'];
            allSections.forEach(id => {
                const element = document.getElementById(id + '-section');
                if (element) element.style.display = 'none';
            });
            
            currentSection = sectionId;
            document.getElementById(sectionId + '-section').style.display = 'block';

            if (sectionId === 'cotizador') {
                loadCotizadorTallas();
                // Inicializar select individual del cotizador con todos los SKUs
                initializeTomSelect('cot-prenda-select', getFilteredSkuOptions('todos'));
                calculateTotal();
            } else if (sectionId === 'historial') {
                loadVentasTable();
            } else if (sectionId === 'registro-ventas') {
                document.getElementById('reg-fecha').value = new Date().toLocaleDateString('es-CO', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '.');
                // Asegurar que haya al menos una fila y se inicialicen los selects
                if (Object.keys(selectedItems).length === 0) {
                    addRow(); // Asegura la primera fila al entrar a registro de ventas
                }
                loadReciboRows();
                calculateReciboTotal();
            }
        }


        // Filtra las opciones de SKU seg√∫n el nivel (primaria, bachillerato o todos)
        function getFilteredSkuOptions(nivel) {
            let filteredList = [];
            const isManual = nivel === 'manual';
            
            ALL_SKUS_LIST.sort((a, b) => a.name.localeCompare(b.name)).forEach(sku => {
                // Filtra por nivel, o si es "todos", o si es un producto "todos"
                if (isManual || nivel === 'todos' || sku.nivel === 'todos' || sku.nivel.includes(nivel)) {
                    filteredList.push({
                        value: sku.skuKey, 
                        text: `${sku.name} T${sku.talla} (${formatCOP(sku.price)})`
                    });
                }
            });
            return filteredList;
        }

        // Inicializar Tom Select en un elemento
        function initializeTomSelect(elementId, options = [], placeholder = 'Buscar Articulo | Talla (Precio)', initialValue = '') {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return;

            // Destruir si ya existe
            if (tomSelectInstances[elementId]) {
                tomSelectInstances[elementId].destroy();
                delete tomSelectInstances[elementId];
            }
            
            // Cargar opciones
            selectElement.innerHTML = options.map(sku => 
                `<option value="${sku.value}">${sku.text}</option>`
            ).join('');
            
            selectElement.innerHTML = `<option value="">${placeholder}</option>` + selectElement.innerHTML;


            const tomSelect = new TomSelect(`#${elementId}`, {
                valueField: 'value',
                labelField: 'text',
                searchField: ['text'],
                sortField: 'text',
                placeholder: placeholder,
                maxItems: 1,
                create: false,
                onChange: elementId.includes('reg-prod-select') ? (value) => handleProductChange(elementId.split('-')[3], value) : undefined,
            });
            
            if (initialValue) {
                tomSelect.setValue(initialValue);
            }
            
            tomSelectInstances[elementId] = tomSelect;
            return tomSelect;
        }


        // --- 4. Funciones del COTIZADOR R√ÅPIDO ---
        
        function loadCotizadorTallas() {
            const nivelSelect = document.getElementById('cot-nivel-select');
            const tallaSelect = document.getElementById('cot-talla-select');
            tallaSelect.innerHTML = '<option value="">Seleccione Talla</option>';
            const nivel = nivelSelect.value;
            // Unir tallas de todos los productos del nivel seleccionado para mostrar las opciones.
            const nivelKey = nivel.split('-')[0]; // primaria o bachillerato
            let tallasSet = new Set();
            PRODUCTOS_DATA.forEach(prod => {
                if (prod.nivel === nivelKey) {
                    Object.keys(prod.prices).forEach(talla => tallasSet.add(talla));
                }
            });

            const tallas = Array.from(tallasSet).sort((a, b) => {
                const isNumA = !isNaN(a);
                const isNumB = !isNaN(b);
                if (isNumA && isNumB) return parseInt(a) - parseInt(b);
                if (isNumA) return -1;
                if (isNumB) return 1;
                return a.localeCompare(b);
            });
            
            tallas.forEach(talla => {
                const option = document.createElement('option');
                option.value = talla;
                option.textContent = `Talla ${talla}`;
                tallaSelect.appendChild(option);
            });
        }
        
        function addUniformeCompleto() {
            const nivel = document.getElementById('cot-nivel-select').value;
            const talla = document.getElementById('cot-talla-select').value;

            if (!talla) {
                alert("Por favor, seleccione una talla base.");
                return;
            }

            const prendasIds = UNIFORMES_COMPLETOS[nivel];
            if (!prendasIds) {
                alert("Nivel no v√°lido.");
                return;
            }

            let itemsAdded = 0;
            prendasIds.forEach(id => {
                const producto = PRODUCTOS_MAP[id];
                if (producto && producto.prices[talla]) {
                    cotizacionItems.push({
                        id: id,
                        name: producto.name,
                        talla: talla,
                        price: producto.prices[talla],
                        qty: 1
                    });
                    itemsAdded++;
                } else if (producto && id === "JARDINERA_P" && talla < 10 && nivel === 'primaria-nina') {
                    // Si es ni√±a de primaria y la talla es peque√±a, a√±adir Bata en lugar de Jardinera
                    // Se asume que Bata Ni√±a y Jardinera (P) no se usan al mismo tiempo.
                } else if (producto && id === "BATA_NINA" && talla >= 10 && nivel === 'primaria-nina') {
                    // Si es ni√±a de primaria y la talla es grande, a√±adir Jardinera en lugar de Bata
                    // No hacer nada, se a√±ade Jardinera
                } else if (producto && producto.prices[talla] === undefined) {
                    // Si el producto no tiene esa talla, se ignora o se a√±ade una nota (simplificado, solo ignorar)
                    console.warn(`Prenda ${producto.name} no disponible en Talla ${talla}.`);
                }
            });

            if (itemsAdded === 0) {
                 alert("No se pudo a√±adir el uniforme. Verifique la combinaci√≥n Nivel/Talla.");
            } else {
                 renderCotizacionItems();
            }
        }

        function addPrendaIndividual() {
            const selectValue = tomSelectInstances['cot-prenda-select'] ? tomSelectInstances['cot-prenda-select'].getValue() : '';
            const qty = cleanPrice(document.getElementById('cot-qty-indiv').value);

            if (!selectValue) {
                alert("Por favor, seleccione un art√≠culo.");
                return;
            }
            if (qty <= 0) {
                alert("La cantidad debe ser mayor a 0.");
                return;
            }

            const [id, talla, priceStr] = selectValue.split('|');
            const price = cleanPrice(priceStr);

            cotizacionItems.push({
                id: id,
                name: PRODUCTOS_MAP[id] ? PRODUCTOS_MAP[id].name : id,
                talla: talla,
                price: price,
                qty: qty
            });

            renderCotizacionItems();
        }

        function removeCotizacionItem(index) {
            cotizacionItems.splice(index, 1);
            renderCotizacionItems();
        }

        function calculateTotal() {
            const total = cotizacionItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('total-cotizacion').textContent = formatCOP(total);

            const btnWhatsapp = document.getElementById('btn-whatsapp');
            if (total > 0) {
                btnWhatsapp.disabled = false;
            } else {
                btnWhatsapp.disabled = true;
            }
        }

        function renderCotizacionItems() {
            const list = document.getElementById('cotizacion-items-list');
            if (cotizacionItems.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #777;">A√∫n no se han agregado prendas.</p>';
            } else {
                let html = '<ul style="list-style: none; padding: 0;">';
                cotizacionItems.forEach((item, index) => {
                    const subtotal = item.price * item.qty;
                    html += `
                        <li style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dotted #ddd; padding: 8px 0;">
                            <span style="flex: 3; text-align: left;">${item.qty}x ${item.name} T${item.talla}</span>
                            <span style="flex: 1; text-align: right; font-weight: 600;">${formatCOP(subtotal)}</span>
                            <button class="btn-delete" onclick="removeCotizacionItem(${index})" style="flex: 0 0 30px; margin-left: 10px;">üóëÔ∏è</button>
                        </li>
                    `;
                });
                html += '</ul>';
                list.innerHTML = html;
            }
            calculateTotal();
        }

        function resetCotizacion() {
            cotizacionItems = [];
            document.getElementById('cot-cliente-nombre').value = '';
            document.getElementById('cot-cliente-telefono').value = '';
            document.getElementById('cot-qty-indiv').value = 1;
            renderCotizacionItems();
            if (tomSelectInstances['cot-prenda-select']) {
                tomSelectInstances['cot-prenda-select'].clear();
            }
        }

        function enviarWhatsapp() {
            if (cotizacionItems.length === 0) {
                alert("Agregue productos para cotizar primero.");
                return;
            }

            const cliente = document.getElementById('cot-cliente-nombre').value || 'Cliente';
            const telefono = document.getElementById('cot-cliente-telefono').value;
            const total = cotizacionItems.reduce((sum, item) => sum + (item.price * item.qty), 0);

            let mensaje = `üëã Hola, soy ${cliente}. Me gustar√≠a cotizar los siguientes uniformes:\n\n`;

            cotizacionItems.forEach(item => {
                const subtotal = item.price * item.qty;
                mensaje += `* ${item.qty}x ${item.name} T${item.talla} (${formatCOP(item.price)} c/u) = ${formatCOP(subtotal)}\n`;
            });

            mensaje += `\n*TOTAL A PAGAR: ${formatCOP(total)}*\n\n`;
            mensaje += "Por favor, conf√≠rmenme la disponibilidad. ¬°Gracias!";

            const url = `https://wa.me/${WHATSAPP_NEGOCIO}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        // --- 5. Funciones del REGISTRO DE VENTA ---

        function handleProductChange(rowId, selectValue) {
            const isManual = document.getElementById('reg-nivel-ciclo').value === 'manual';
            const qtyInput = document.getElementById(`reg-qty-${rowId}`);
            const priceInput = document.getElementById(`reg-unit-price-${rowId}`);

            if (selectValue) {
                const [id, talla, priceStr] = selectValue.split('|');
                const price = cleanPrice(priceStr);
                const name = PRODUCTOS_MAP[id] ? PRODUCTOS_MAP[id].name : id;
                
                selectedItems[rowId] = {
                    qty: cleanPrice(qtyInput.value) || 1,
                    name: name,
                    talla: talla,
                    price: price,
                    entregado: document.getElementById(`reg-entregado-${rowId}`).checked
                };
                
                priceInput.value = isManual ? '' : formatPriceInput(price); // Si es manual, se deja vac√≠o para que el usuario escriba
                priceInput.disabled = !isManual;
                priceInput.setAttribute('onkeyup', isManual ? `this.value=formatPriceInput(this.value); updateRowTotal(${rowId})` : '');


            } else {
                // Si se deselecciona
                delete selectedItems[rowId];
                priceInput.value = isManual ? '' : '0';
                priceInput.disabled = !isManual;
                priceInput.setAttribute('onkeyup', isManual ? `this.value=formatPriceInput(this.value); updateRowTotal(${rowId})` : '');
            }
            
            updateRowTotal(rowId);
        }
        
        function updateRowData(rowId, field, value) {
            if (!selectedItems[rowId]) return;

            if (field === 'qty') {
                selectedItems[rowId].qty = cleanPrice(value);
            } else if (field === 'price') {
                selectedItems[rowId].price = cleanPrice(value);
            } else if (field === 'talla') {
                selectedItems[rowId].talla = value;
            } else if (field === 'entregado') {
                 selectedItems[rowId].entregado = value;
            }

            updateRowTotal(rowId);
        }

        function updateRowTotal(rowId) {
            const item = selectedItems[rowId];
            const qtyInput = document.getElementById(`reg-qty-${rowId}`);
            const priceInput = document.getElementById(`reg-unit-price-${rowId}`);
            const totalDisplay = document.getElementById(`reg-total-price-${rowId}`);
            
            const qty = cleanPrice(qtyInput.value);
            const price = cleanPrice(priceInput.value);
            
            const total = qty * price;
            totalDisplay.value = formatCOP(total).replace('$', '').trim(); // Muestra solo el n√∫mero

            // Actualizar el objeto selectedItems para el c√°lculo final
            if (item) {
                item.qty = qty;
                item.price = price;
            } else if (qty > 0 || price > 0) {
                 // Caso para la fila manual sin select
                 const nameInput = document.getElementById(`reg-name-manual-${rowId}`);
                 const tallaInput = document.getElementById(`reg-talla-manual-${rowId}`);

                 selectedItems[rowId] = {
                    qty: qty,
                    name: nameInput ? nameInput.value : 'Producto Manual',
                    talla: tallaInput ? tallaInput.value : '-',
                    price: price,
                    entregado: document.getElementById(`reg-entregado-${rowId}`).checked
                 };
            }

            calculateReciboTotal();
        }

        function calculateReciboTotal() {
            let subtotal = 0;
            // Recalcula el subtotal a partir de los items en la tabla (incluidos los manuales)
            document.querySelectorAll('#recibo-productos-tbody tr').forEach(row => {
                const rowId = row.dataset.rowId;
                const qty = cleanPrice(document.getElementById(`reg-qty-${rowId}`).value);
                const price = cleanPrice(document.getElementById(`reg-unit-price-${rowId}`).value);
                
                if(qty > 0 && price > 0) {
                     subtotal += qty * price;

                     // Asegurar que el selectedItems se actualice para los campos manuales
                     const isManual = document.getElementById('reg-nivel-ciclo').value === 'manual';
                     if (isManual) {
                        const nameInput = document.getElementById(`reg-name-manual-${rowId}`);
                        const tallaInput = document.getElementById(`reg-talla-manual-${rowId}`);
                        if (nameInput && tallaInput) {
                            selectedItems[rowId] = {
                                qty: qty,
                                name: nameInput.value || 'Producto Manual',
                                talla: tallaInput.value || '-',
                                price: price,
                                entregado: document.getElementById(`reg-entregado-${rowId}`).checked
                            };
                        }
                     }
                }
            });


            const descuento = cleanPrice(document.getElementById('reg-descuento').value);
            const abono = cleanPrice(document.getElementById('reg-abono').value);

            const total = Math.max(0, subtotal - descuento);
            const saldo = Math.max(0, total - abono);

            document.getElementById('reg-subtotal-display').textContent = formatCOP(subtotal);
            document.getElementById('reg-total-display').textContent = formatCOP(total);
            document.getElementById('reg-saldo-display').textContent = formatCOP(saldo);
        }


        function addRow() {
            currentRowId++;
            const tbody = document.getElementById('recibo-productos-tbody');
            const row = tbody.insertRow();
            row.dataset.rowId = currentRowId;
            row.id = `row-${currentRowId}`;

            const nivel = document.getElementById('reg-nivel-ciclo').value;
            const isManual = nivel === 'manual';
            const options = getFilteredSkuOptions(nivel);
            const placeholder = isManual ? 'Escriba Descripci√≥n' : 'Buscar Articulo | Talla (Precio)';
            const selectHtml = isManual 
                ? `<input type="text" id="reg-name-manual-${currentRowId}" placeholder="Ej: Camisa M/L" onkeyup="updateRowData(${currentRowId}, 'name', this.value)">`
                : `<select id="reg-prod-select-${currentRowId}"></select>`;
            const tallaInput = isManual 
                ? `<input type="text" id="reg-talla-manual-${currentRowId}" value="-" placeholder="Ej: 12" onkeyup="updateRowData(${currentRowId}, 'talla', this.value)">`
                : `<input type="text" id="reg-talla-${currentRowId}" value="-" disabled>`;


            row.innerHTML = `
                <td><input type="number" id="reg-qty-${currentRowId}" value="1" min="1" onchange="updateRowData(${currentRowId}, 'qty', this.value)" style="width: 50px;"></td>
                <td>${selectHtml}</td>
                <td>${tallaInput}</td>
                <td><input type="text" id="reg-unit-price-${currentRowId}" value="0" placeholder="0" onkeyup="this.value=formatPriceInput(this.value); updateRowTotal(${currentRowId})" ${isManual ? '' : 'disabled'}></td>
                <td><input type="text" id="reg-total-price-${currentRowId}" value="0" disabled></td>
                <td><input type="checkbox" id="reg-entregado-${currentRowId}" onchange="updateRowData(${currentRowId}, 'entregado', this.checked)"></td>
                <td><button class="btn-delete" onclick="removeRow(${currentRowId})">üóëÔ∏è</button></td>
            `;

            if (!isManual) {
                // Inicializar Tom Select para la fila
                initializeTomSelect(`reg-prod-select-${currentRowId}`, options, placeholder);
                // Si no hay opciones, puede que el nivel no tenga productos, pero esto ya se filtra en getFilteredSkuOptions
            }
            
            // Inicializar el item en selectedItems si es manual para que el c√°lculo inicial funcione
            if (isManual) {
                 selectedItems[currentRowId] = {
                    qty: 1,
                    name: '',
                    talla: '-',
                    price: 0,
                    entregado: false
                 };
            }
        }

        function removeRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                 // Destruir la instancia de Tom Select asociada si existe
                 if (tomSelectInstances[`reg-prod-select-${rowId}`]) {
                     tomSelectInstances[`reg-prod-select-${rowId}`].destroy();
                     delete tomSelectInstances[`reg-prod-select-${rowId}`];
                 }
                 // Eliminar de los items seleccionados
                 delete selectedItems[rowId];
                 // Eliminar la fila
                 row.remove();
                 // Recalcular el total
                 calculateReciboTotal();

                 // Si no quedan filas y no es manual, a√±adir una
                 if (document.getElementById('recibo-productos-tbody').children.length === 0 && document.getElementById('reg-nivel-ciclo').value !== 'manual') {
                    addRow();
                 }
            }
        }
        
        function loadReciboRows() {
             // Limpiar tabla, eliminar selects e items seleccionados
             document.getElementById('recibo-productos-tbody').innerHTML = '';
             Object.values(tomSelectInstances).forEach(ts => {
                 if (ts && typeof ts.destroy === 'function' && ts.settings.onChange) ts.destroy();
             });
             tomSelectInstances = {};
             selectedItems = {};
             currentRowId = 0;
             addRow();
        }

        function resetReciboSelects() {
             loadReciboRows(); // Recarga la tabla con el nuevo filtro (o sin √©l)
             calculateReciboTotal(); // Recalcula (dar√° $0)
        }
        
        // --- 6. Funciones de Base de Datos y Persistencia ---

        function registrarVenta() {
            const talonario = document.getElementById('reg-talonario').value;
            const nombre = document.getElementById('reg-nombre').value.trim();
            const celular = document.getElementById('reg-celular').value.trim();
            const fecha = document.getElementById('reg-fecha').value;
            const metodoPago = document.getElementById('reg-metodo-pago').value;
            const nivelCiclo = document.getElementById('reg-nivel-ciclo').value;
            const descuento = cleanPrice(document.getElementById('reg-descuento').value);
            const abono = cleanPrice(document.getElementById('reg-abono').value);
            
            // Medidas/Arreglos
            const medidas = {
                cadera: document.getElementById('medida-cadera').value.trim(),
                busto: document.getElementById('medida-busto').value.trim(),
                cintura: document.getElementById('medida-cintura').value.trim(),
                largo: document.getElementById('medida-largo').value.trim(),
                ancho: document.getElementById('medida-ancho').value.trim(),
                otros: document.getElementById('medida-otros').value.trim(),
            };


            if (!nombre || !talonario) {
                alert("El Nombre del Cliente y el No. de Recibo son campos obligatorios.");
                return;
            }

            // Filtrar solo los items con cantidad y precio v√°lidos
            const itemsValidos = Object.values(selectedItems).filter(item => item.qty > 0 && item.price > 0 && item.name);
            
            if (itemsValidos.length === 0) {
                 alert("La venta debe contener al menos un producto con cantidad y precio v√°lidos.");
                 return;
            }
            
            const subtotal = itemsValidos.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const total = Math.max(0, subtotal - descuento);
            const saldo = Math.max(0, total - abono);
            const estado = saldo > 0 ? 'Pendiente' : 'Entregado';
            const todosEntregados = itemsValidos.every(item => item.entregado);
            const estadoEntrega = todosEntregados ? 'Completa' : (itemsValidos.some(item => item.entregado) ? 'Parcial' : 'Pendiente');

            const nuevaVenta = {
                id: Date.now(), // ID √∫nico basado en timestamp
                recibo: talonario,
                fecha: fecha,
                cliente: nombre,
                celular: celular,
                metodoPago: metodoPago,
                nivelCiclo: nivelCiclo,
                items: itemsValidos,
                medidas: medidas,
                subtotal: subtotal,
                descuento: descuento,
                total: total,
                abono: abono,
                saldo: saldo,
                estado: estado, // Pagado / Pendiente
                estadoEntrega: estadoEntrega, // Completa / Parcial / Pendiente
            };

            ventas.push(nuevaVenta);
            localStorage.setItem('ventasDB', JSON.stringify(ventas));

            alert(`‚úÖ Venta No. ${talonario} registrada con √©xito. Saldo: ${formatCOP(saldo)}`);
            
            // Resetear el formulario de registro de venta
            resetRegistroVenta();
            showSection('historial');
        }
        
        function resetRegistroVenta() {
            // Limpiar campos del cliente y venta
            document.getElementById('reg-talonario').value = '';
            document.getElementById('reg-nombre').value = '';
            document.getElementById('reg-celular').value = '';
            document.getElementById('reg-metodo-pago').value = 'Efectivo';
            document.getElementById('reg-nivel-ciclo').value = 'todos';
            document.getElementById('reg-descuento').value = '0';
            document.getElementById('reg-abono').value = '0';
            
            // Limpiar medidas
            document.getElementById('medida-cadera').value = '';
            document.getElementById('medida-busto').value = '';
            document.getElementById('medida-cintura').value = '';
            document.getElementById('medida-largo').value = '';
            document.getElementById('medida-ancho').value = '';
            document.getElementById('medida-otros').value = '';

            // Recargar filas y totales (vac√≠os)
            loadReciboRows();
            calculateReciboTotal();
        }

        function loadVentasTable() {
            const tbody = document.querySelector('#ventas-table tbody');
            tbody.innerHTML = ''; // Limpiar tabla

            // Ordenar por recibo de mayor a menor
            const ventasOrdenadas = [...ventas].sort((a, b) => cleanPrice(b.recibo) - cleanPrice(a.recibo));

            ventasOrdenadas.forEach((venta) => {
                const row = tbody.insertRow();

                // Detalle de productos para mostrar en la tabla (ej. 2x Camisa T10, 1x Pantal√≥n T12)
                const itemsStr = venta.items.map(item => {
                    const entregadoEmoji = item.entregado ? '‚úîÔ∏è' : '‚ùå';
                    return `${item.qty}x ${item.name} T${item.talla} ${entregadoEmoji}`;
                }).join('<br>');
                
                const estadoClass = venta.saldo > 0 ? 'status-pendiente' : 'status-entregado';
                const estadoText = venta.saldo > 0 ? `PENDIENTE (${formatCOP(venta.saldo)})` : 'PAGADO';
                
                row.innerHTML = `
                    <td>${venta.recibo}</td>
                    <td>${venta.fecha}</td>
                    <td>${venta.cliente} <br> <small style="color: #777;">${venta.celular || 'S/N'}</small></td>
                    <td>${formatCOP(venta.total)}</td>
                    <td>${formatCOP(venta.abono)}</td>
                    <td class="${estadoClass}">${formatCOP(venta.saldo)}</td>
                    <td>${estadoText} <br> <small style="font-size: 0.9em; font-weight: bold; color: ${venta.estadoEntrega === 'Completa' ? var(--color-success) : (venta.estadoEntrega === 'Parcial' ? var(--color-info) : var(--color-danger))};">${venta.estadoEntrega}</small></td>
                    <td style="text-align: left; font-size: 0.9em;">${itemsStr}</td>
                    <td>
                        <button class="btn-secondary" onclick="imprimirRecibo(${venta.id})" style="margin: 5px; padding: 5px 10px; font-size: 0.9em;">üñ®Ô∏è Recibo</button>
                        <button class="btn-delete" onclick="eliminarVenta(${venta.id})" style="margin: 5px; padding: 5px 10px; font-size: 0.9em;">üóëÔ∏è Eliminar</button>
                    </td>
                `;
            });
        }
        
        function eliminarVenta(id) {
            if (confirm("¬øEst√°s seguro de que deseas eliminar esta venta? Esta acci√≥n no se puede deshacer.")) {
                ventas = ventas.filter(v => v.id !== id);
                localStorage.setItem('ventasDB', JSON.stringify(ventas));
                loadVentasTable();
            }
        }

        function resetDatabase() {
            if (confirm("ATENCI√ìN: ¬øEst√°s ABSOLUTAMENTE seguro de que deseas ELIMINAR TODO EL HISTORIAL DE VENTAS? Esta acci√≥n es irreversible.")) {
                ventas = [];
                localStorage.removeItem('ventasDB');
                alert("Base de datos de ventas eliminada.");
                loadVentasTable();
            }
        }
        
        // --- 7. Funciones de Impresi√≥n / Descarga ---

        function imprimirRecibo(id) {
             const venta = ventas.find(v => v.id === id);
             if (!venta) return;

             // Construir el contenido para imprimir
             let content = `
                 <style>
                     body { font-family: sans-serif; margin: 0; padding: 10px; font-size: 10pt; }
                     h2 { text-align: center; margin: 0; font-size: 14pt; }
                     .header-info, .client-info, .summary { border: 1px solid #000; padding: 5px; margin-bottom: 5px; }
                     table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                     th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
                     th { background-color: #eee; }
                     .summary p { margin: 2px 0; }
                     .total { font-weight: bold; font-size: 12pt; }
                 </style>
                 <h2>UNIFORMES DON BOSCO</h2>
                 <p style="text-align: center; margin-top: 5px; margin-bottom: 10px;">Recibo de Venta No. ${venta.recibo}</p>
                 
                 <div class="client-info">
                     <p><strong>Fecha:</strong> ${venta.fecha}</p>
                     <p><strong>Cliente:</strong> ${venta.cliente}</p>
                     <p><strong>Celular:</strong> ${venta.celular || 'N/A'}</p>
                     <p><strong>Nivel/Tipo:</strong> ${venta.nivelCiclo}</p>
                 </div>
                 
                 <table>
                     <thead>
                         <tr>
                             <th style="width: 5%;">Cant</th>
                             <th style="width: 45%;">Art√≠culo</th>
                             <th style="width: 15%;">Talla</th>
                             <th style="width: 15%;">V/Unit</th>
                             <th style="width: 20%;">V/Total</th>
                         </tr>
                     </thead>
                     <tbody>
                         ${venta.items.map(item => `
                             <tr>
                                 <td>${item.qty}</td>
                                 <td>${item.name}</td>
                                 <td>${item.talla}</td>
                                 <td>${formatCOP(item.price)}</td>
                                 <td>${formatCOP(item.qty * item.price)}</td>
                             </tr>
                         `).join('')}
                     </tbody>
                 </table>
                 
                 <div class="summary">
                     <p><strong>Subtotal:</strong> ${formatCOP(venta.subtotal)}</p>
                     <p><strong>Descuento:</strong> ${formatCOP(venta.descuento)}</p>
                     <p class="total"><strong>TOTAL A PAGAR:</strong> ${formatCOP(venta.total)}</p>
                     <hr style="border-top: 1px dashed #000; margin: 5px 0;">
                     <p><strong>Abono (${venta.metodoPago}):</strong> ${formatCOP(venta.abono)}</p>
                     <p class="total" style="color: ${venta.saldo > 0 ? 'red' : 'green'};"><strong>SALDO PENDIENTE:</strong> ${formatCOP(venta.saldo)}</p>
                     <p style="margin-top: 10px; font-size: 9pt;"><strong>Estado Entrega:</strong> ${venta.estadoEntrega}</p>
                     <p style="font-size: 9pt;"><strong>Items Pendientes:</strong> ${venta.items.filter(i => !i.entregado).map(i => `${i.qty}x ${i.name} T${i.talla}`).join(', ') || 'N/A'}</p>
                 </div>
                 
                 ${(venta.medidas.cadera || venta.medidas.busto || venta.medidas.otros) ? `
                     <div class="summary" style="margin-top: 10px;">
                         <p style="font-weight: bold;">Medidas/Arreglos:</p>
                         <p>${Object.keys(venta.medidas).filter(k => venta.medidas[k]).map(k => `${k}: ${venta.medidas[k]}`).join(' | ')}</p>
                     </div>
                 ` : ''}
                 
                 <p style="text-align: center; margin-top: 30px; font-size: 9pt;">------------------------------</p>
                 <p style="text-align: center; margin-top: 5px; font-size: 9pt;">Firma del Cliente</p>
                 <p style="text-align: center; margin-top: 5px; font-size: 8pt;">¬°Gracias por su compra!</p>
             `;

             // Abrir ventana de impresi√≥n
             const printWindow = window.open('', '', 'height=600,width=800');
             printWindow.document.write(content);
             printWindow.document.close();
             printWindow.print();
        }
        
        function descargarExcel() {
            if (ventas.length === 0) {
                alert("No hay ventas para descargar.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Encabezados
            const headers = ["Recibo", "Fecha", "Cliente", "Celular", "Metodo Pago", "Nivel/Tipo", "Subtotal", "Descuento", "Total", "Abono", "Saldo", "Estado Pago", "Estado Entrega", "Detalle Productos (Cant/Nombre/Talla/V.Unit)", "Medidas"];
            csvContent += headers.join(";") + "\n";

            // Filas
            ventas.forEach(venta => {
                const itemsStr = venta.items.map(item => 
                    `${item.qty}x ${item.name} T${item.talla} (${formatCOP(item.price)})`
                ).join(" | ");
                
                const medidasStr = Object.keys(venta.medidas).filter(k => venta.medidas[k]).map(k => `${k}: ${venta.medidas[k]}`).join(' | ');
                
                const row = [
                    venta.recibo,
                    venta.fecha,
                    venta.cliente,
                    venta.celular,
                    venta.metodoPago,
                    venta.nivelCiclo,
                    venta.subtotal,
                    venta.descuento,
                    venta.total,
                    venta.abono,
                    venta.saldo,
                    venta.saldo > 0 ? 'Pendiente' : 'Pagado',
                    venta.estadoEntrega,
                    `"${itemsStr}"`, // Comillas para manejar comas internas
                    `"${medidasStr}"`
                ];
                csvContent += row.join(";") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `historial_ventas_don_bosco_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 8. Inicializaci√≥n ---
        window.onload = function() {
             showSection('inicio');
             // Inicializar la primera fila en registro-ventas si no hay items
             document.getElementById('reg-fecha').value = new Date().toLocaleDateString('es-CO', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '.');
             if (document.getElementById('recibo-productos-tbody').children.length === 0) {
                 addRow();
             }
        };

        // Asegurarse de que las filas manuales o de producto se actualicen al cambiar la cantidad
        // Esto se maneja mejor en la funci√≥n addRow/updateRowData/calculateReciboTotal
        
    </script>
</body>
</html>
